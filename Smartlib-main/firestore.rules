rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Hanya admin bisa write ke books
    match /books/{bookId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Anggota hanya write loans untuk diri sendiri, reviews untuk buku yang pernah pinjam
    match /loans/{loanId} {
      allow read, write: if request.auth != null && (request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    match /reviews/{reviewId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Users: Admin bisa update active, user sendiri read
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Backups: Admin only
    match /backups/{backupId} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Validasi: String max length, rating 1-5
    function isValidBook() {
      return request.resource.data.title is string && request.resource.data.title.size() <= 200 &&
             request.resource.data.rating is int && request.resource.data.rating >= 1 && request.resource.data.rating <= 5;
    }
  }
}
